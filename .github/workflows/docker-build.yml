name: Docker Build and Push

on:
  push:
    branches:
      - develop
  pull_request:
    # 원하는 브랜치를 지정할 수 있습니다.
    # branches:
    #   - develop
  # workflow_dispatch:

env:
  IMAGE_STORAGE: "docker.io"
  IMAGE_NAME_PREFIX: "leovim5072/moheng-"
  DOCKERHUB_USERNAME: "leovim5072"

jobs:
  docker-login:
    runs-on: ubuntu-latest
    steps:
      - name: Docker Login Test
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

  build-and-push:
    needs: [docker-login]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - nginx
          - backend
          - ai
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Image
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME_PREFIX }}${{ matrix.service }}:latest
        run: |
          echo "Starting ${{ matrix.service }} Build..."
          cd ${{ matrix.service }}

          if [ "${{ matrix.service }}" == "nginx" ]; then
            DOCKERFILE="Dockerfile.prod"
            CONTEXT="../"
          elif [ "${{ matrix.service }}" == "backend" ]; then
            DOCKERFILE="Dockerfile.prod"
            CONTEXT="."
          else
            DOCKERFILE="Dockerfile"
            CONTEXT="."
          fi

          docker build -t $IMAGE_NAME -f $DOCKERFILE $CONTEXT
          echo "Build Completed!"

      - name: Push Image
        if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME_PREFIX }}${{ matrix.service }}:latest
        run: |
          echo "Pushing $IMAGE_NAME to Docker Registry..."
          docker push $IMAGE_NAME
          echo "Push Completed!"

  send-notification:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        uses: Ilshidur/action-discord@master
        with:
          webhook: ${{ env.DISCORD_WEBHOOK }}
          title: "Build ${{ job.status }} - ${{ github.repository }}"
          description: |
          #   **Branch**: ${{ github.ref }}
          #   **Status**: ${{ job.status }}
          #   **Event**: ${{ github.event_name }}
          # color: ${{ job.status == 'success' && '3066993' || '15158332' }}
