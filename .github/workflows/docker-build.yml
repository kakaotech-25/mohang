name: Docker Build and Push

on:
  push:
    branches:
      - develop
  pull_request:

env:
  IMAGE_STORAGE: "https://registry.hub.docker.com"
  IMAGE_NAME_PREFIX: "leovim5072/moheng-"
  DOCKERHUB_USERNAME: "leovim5072"
  SCRIPTS_DIR: .github/scripts/build

jobs:
  docker-login:
    runs-on: ubuntu-latest
    steps:
      - name: Docker Login Test
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

  build-and-push:
    needs: [docker-login]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: nginx
            dockerfile: nginx/Dockerfile.prod
            context: .
          - service: backend
            dockerfile: backend/Dockerfile.prod
            context: backend
          - service: ai
            dockerfile: ai/Dockerfile
            context: ai
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: build and Push Docker Image
        uses: docker/build-push-action@v6
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME_PREFIX }}${{ matrix.service }}:latest
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/develop' }}
          tags: ${{ env.IMAGE_NAME }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  send-notification:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Send Discord Notification via Shell Script
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BUILD_STATUS: ${{ job.status }}
        if: always()
        run: |
          chmod +x ${{ env.SCRIPTS_DIR }}/send_discord_pipeline.sh && \
          ${{ env.SCRIPTS_DIR }}/send_discord_pipeline.sh \
          "${DISCORD_WEBHOOK}" \
          "${GITHUB_WORKFLOW}" \
          "${GITHUB_ACTOR}" \
          "${GITHUB_REF_NAME}" \
          "${GITHUB_SHA}" \
          "${GITHUB_REPOSITORY}" \
          "${BUILD_STATUS}"
